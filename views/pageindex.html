{#
This software is licensed under the 3-clause BSD license.
You should have recieved a copy of such license with this software,
if you did not, a copy can be found at the following

    https://opensource.org/license/BSD-3-Clause

Otherwise, a copy of this license can be found in the root directory
of this project.
#}
{% extends "_layout.html" %}

{% block head %}
{{super()}}
<script type="module" defer="defer">
const PageIndex = document.querySelector(".page-index");
const SearchForm = document.querySelector("search form");
const AllPages = PageIndex.querySelectorAll("li");

function formsubmit() {
    const searchtext = SearchForm.querySelector("#search").value;
    history.pushState({ search: searchtext }, document.title, "?search=" + encodeURIComponent(searchtext));
    sortpagelist(searchtext);
}

async function sortpagelist(searchtext) {
    const sortfunc = (a, b) => {
        if (
            a[0].toLowerCase() == searchtext.toLowerCase()
        ) return 1
        if (
            a[0].toLowerCase().includes(searchtext.toLowerCase()) &&
            !(b[0].toLowerCase().includes(searchtext.toLowerCase()))
        ) return -1;
        if (
            !(a[0].toLowerCase().includes(searchtext.toLowerCase())) &&
            b[0].toLowerCase().includes(searchtext.toLowerCase())
        ) return 1;
        return 0;
    };
    PageIndex.innerHTML = "";
    const Pages = await new Promise((res, rej) => {
        let parsed = [];
        for (let index = 0; index < AllPages.length; index++) {
            parsed.push([
                AllPages[index].dataset.title,
                AllPages[index].dataset.href
            ]);
            if (parsed.length == AllPages.length) {
                res(parsed);
            }
        } 
    });
    const sortedpages = Pages.toSorted(sortfunc);
    for (let index in sortedpages) {
        const element = sortedpages[index];

        const Append = document.createElement("li");
        Append.dataset.title = element[0];
        Append.dataset.href = element[1];

        const anchor = document.createElement("a");
        anchor.href = element[1];
        anchor.textContent = element[0];
        Append.appendChild(anchor);
        PageIndex.appendChild(Append);
    }
}

SearchForm.addEventListener("submit", e => {
    e.preventDefault();
    formsubmit()
});
</script>
{% endblock %}

{% block main %}
<h1>Page Index</h1>

<search>
  <form>
    <label for="search">
        Search text
    </label>
    <input
      type="search" id="search"
      name="search" />
    <button type="submit" class="searchbutton">
        Search
    </button>
  </form>
</search>

<ul class="page-index">
    {% for href, title in pages %}
    <li
        data-title="{{title}}"
        data-href="{{href}}"
    >
        <a href="{{ href }}">{{ title }}</a>
    </li>
    {% endfor %}
</ul>
{% endblock %}
